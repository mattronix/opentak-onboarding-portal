# Version Display Implementation

## Overview

The application now displays version information based on the git commit hash in both frontend and backend.

## Frontend Version Display

### Location
- **Bottom left corner** of the footer on all pages
- Format: `vXXXXXXXXXXXX` (12-character git commit hash)
- Example: `vad5b884563ba`

### Implementation

**Files:**
- `frontend/generate-version.js` - Generates version.json during build
- `frontend/src/components/Layout.jsx` - Displays version in footer
- `frontend/public/version.json` - Auto-generated (gitignored)

**How it works:**
1. During `npm run build`, `generate-version.js` runs first
2. It gets the git commit hash and date
3. Creates `public/version.json` with version info
4. Vite copies it to `dist/version.json` during build
5. Layout component fetches and displays the version

### Local Development Build

```bash
cd frontend
npm run build
```

This automatically generates the version file.

### Docker Build

The Dockerfile accepts build arguments for version:

```bash
# Using the helper script (recommended)
./docker-build.sh

# Or manually
GIT_COMMIT=$(git rev-parse --short=12 HEAD)
GIT_DATE=$(git log -1 --format=%cd --date=short)

docker compose build \
  --build-arg GIT_COMMIT="${GIT_COMMIT}" \
  --build-arg GIT_DATE="${GIT_DATE}"
```

## Backend Version Display

### API Endpoint
- **URL:** `/api/v1/version`
- **Method:** GET
- **Authentication:** None required
- **Response:**
  ```json
  {
    "commit": "ad5b884563ba",
    "date": "2025-10-17",
    "build_time": "2025-10-16T23:43:20.445998Z"
  }
  ```

### Implementation

**Files:**
- `generate_version.py` - Generates app/version.py (run locally)
- `app/version.py` - Auto-generated (gitignored)
- `app/api_v1/version.py` - API endpoint

**How it works:**

**Local Development:**
```bash
# Generate version file
python generate_version.py

# Or let Flask auto-detect (uses fallback "dev")
flask run
```

**Docker:**
The Dockerfile creates `app/version.py` using build arguments.

## Version File Structure

### Frontend: version.json
```json
{
  "commit": "ad5b884563ba",
  "date": "2025-10-17",
  "buildTime": "2025-10-16T23:43:20.497Z"
}
```

### Backend: version.py
```python
"""Auto-generated version information"""

COMMIT = 'ad5b884563ba'
DATE = '2025-10-17'
BUILD_TIME = '2025-10-16T23:43:20.445998Z'

def get_version():
    """Get version dict"""
    return {
        'commit': COMMIT,
        'date': DATE,
        'build_time': BUILD_TIME
    }
```

## Deployment

### Production Deployment with Version

**On production server:**

```bash
cd /path/to/opentak-onboarding-portal

# Pull latest code
git pull origin main

# Build with version info
./docker-build.sh

# Start container
docker compose up -d
```

### Verifying Version

**Frontend:**
1. Open the application in browser
2. Look at bottom left of footer
3. Should show: `vXXXXXXXXXXXX`

**Backend:**
```bash
curl http://localhost:5000/api/v1/version
```

**Checking if versions match:**
Both frontend and backend should show the same commit hash if they were built from the same git commit.

## Troubleshooting

### Frontend shows "vdev"

**Cause:** Version file not generated during build.

**Solution:**
```bash
cd frontend
npm run build  # This runs generate-version.js automatically
```

### Backend shows "dev"

**Cause:** `app/version.py` doesn't exist or couldn't be generated.

**Solution:**
```bash
# Local development
python generate_version.py

# Docker
# Make sure to use docker-build.sh or pass build args
./docker-build.sh
```

### Docker build fails

**Cause:** Not passing version build arguments.

**Solution:**
Always use `docker-build.sh` or manually pass build args:
```bash
docker compose build \
  --build-arg GIT_COMMIT="$(git rev-parse --short=12 HEAD)" \
  --build-arg GIT_DATE="$(git log -1 --format=%cd --date=short)"
```

### Versions don't match between frontend and backend

**Cause:** Built at different times or from different commits.

**Solution:**
Rebuild both in the same Docker build:
```bash
./docker-build.sh
docker compose up -d
```

## File Locations

### Generated Files (Gitignored)
- `frontend/public/version.json` - Frontend version (generated by npm build)
- `frontend/dist/version.json` - Copied from public/ by Vite
- `app/version.py` - Backend version (generated by script or Dockerfile)

### Source Files (Committed to Git)
- `frontend/generate-version.js` - Frontend version generator
- `generate_version.py` - Backend version generator
- `app/api_v1/version.py` - Backend version API endpoint
- `docker-build.sh` - Docker build helper script
- `Dockerfile` - Includes version generation logic

### Configuration Files
- `frontend/package.json` - Runs generate-version.js before build
- `app/api_v1/__init__.py` - Registers version endpoint
- `.gitignore` - Excludes auto-generated version files

## Version Format

**Short Hash (12 characters):** `ad5b884563ba`
- Used for display
- Uniquely identifies a specific commit
- Short enough to be readable
- Long enough to avoid collisions

**Why 12 characters?**
- Git default short hash is 7 chars, but collisions can occur
- 12 chars provides ~68 billion unique combinations
- Industry standard for docker image tags
- Used by GitHub, Docker Hub, etc.

## Benefits

1. **Debugging:** Quickly identify which version is deployed
2. **Verification:** Ensure frontend and backend are in sync
3. **Deployment tracking:** Know exactly what code is running
4. **Rollback:** Easy to identify which commit to revert to
5. **Support:** Users can report the version they're using

## Example Usage

### User reports a bug

**User:** "I'm seeing an error on the Meshtastic page"

**You:** "What version are you using? Check bottom left of the page."

**User:** "v152c5fe3f18f"

**You:** "Ah, that's from before the Meshtastic fix. Please refresh your browser to get vad5b884563ba or later."

### Verifying production deployment

```bash
# SSH into production
ssh user@portal.kggdutchies.nl

# Check what's deployed
curl http://localhost:5000/api/v1/version

# Compare with current commit
git log -1 --format=%h

# If they match, deployment is up to date
```

---

**Created:** October 17, 2025
**Last Updated:** October 17, 2025
